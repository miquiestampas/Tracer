import{k as Ce,l,m as Le,q as Te,p as d,j as e,B as H,G as me,r as $e,n as M,M as ke,o as Ne,T as A}from"./index-ChNr1GaT.js";import{g as Pe}from"./casosApi-CONg4Tmm.js";import{g as Fe,A as Re,u as Oe,d as ze}from"./archivosApi-Ba9CRSX7.js";import{A as D,I as L,b as qe,a as He}from"./api-B9d806Z_.js";import{r as Ge,u as Be,L as ge,T as u}from"./xlsx-ULsuK5bU.js";import{u as Ue,T as xe,S as ve,a as fe,A as je}from"./Title-DqhdHHkm.js";import{S as G}from"./Select-CmOM9iEN.js";import{R as B,F as Ve,I as Xe,D as U}from"./IconFileSpreadsheet-TXNZDDBe.js";import{I as Ye,a as be}from"./IconUpload-DHJEEtc7.js";/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var Je=Ce("outline","download","IconDownload",[["path",{d:"M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2",key:"svg-0"}],["path",{d:"M7 11l5 5l5 -5",key:"svg-1"}],["path",{d:"M12 4l0 12",key:"svg-2"}]]);/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var Qe=Ce("outline","settings","IconSettings",[["path",{d:"M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z",key:"svg-0"}],["path",{d:"M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0",key:"svg-1"}]]);const I={LPR:["Matricula","Fecha","Hora","ID_Lector"],GPS:["Matricula","Fecha","Hora","Coordenada_X","Coordenada_Y"]},V={LPR:["Carril","Velocidad","Coordenada_X","Coordenada_Y"],GPS:["Velocidad"]},We={Matricula:["matricula","matrícula","plate","license","licensenumber","numplaca","patente","licenseplate"],Fecha:["fecha","date","fec"],Hora:["hora","time","timestamp"],ID_Lector:["id_lector","idlector","lector","camara","cámara","device","reader","dispositivo"],Coordenada_X:["coordenada_x","coord_x","coordx","longitud","longitude","lon","x","este","easting"],Coordenada_Y:["coordenada_y","coord_y","coordy","latitud","latitude","lat","y","norte","northing"],Velocidad:["velocidad","speed","vel","v","kmh"],Carril:["carril","lane","via"]};function ca(){const[f,Ee]=l.useState([]),[Se,X]=l.useState(!0),[Ae,Y]=l.useState(null),[n,J]=l.useState(null),[Q,W]=l.useState(null),[c,Ie]=l.useState("LPR"),[i,j]=l.useState(null),[y,b]=l.useState([]),[ye,{open:K,close:Z}]=Ue(!1),[C,x]=l.useState({}),[h,T]=l.useState(!1),[E,S]=l.useState(null),[v,ee]=l.useState(!1),[ae,_]=l.useState(null),[oe,w]=l.useState([]),[$,se]=l.useState(!1),[k,N]=l.useState(null),[re,le]=l.useState(null),te=Le(),ne=Te();l.useEffect(()=>{(async()=>{X(!0),Y(null);try{const t=(await Pe()).map(o=>({value:o.ID_Caso.toString(),label:`${o.ID_Caso} - ${o.Nombre_del_Caso} (${o.Año})`}));Ee(t)}catch{Y("Error al cargar la lista de casos.")}finally{X(!1)}})()},[]),l.useEffect(()=>{var s,t,o;const a=(s=ne.state)==null?void 0:s.preselectedCasoId;if(a!=null&&f.length>0&&!n){const r=String(a);if(f.some(g=>g.value===r)){console.log(`[ImportarPage] Preseleccionando caso ID: ${r}`),J(r);const g=(t=f.find(F=>F.value===r))==null?void 0:t.label;g&&W(((o=g.split(" - ")[1])==null?void 0:o.split(" (")[0])||"Caso seleccionado")}else console.warn(`[ImportarPage] El ID de caso preseleccionado (${r}) no se encontró en la lista.`)}},[ne.state,f,n,te]);const P=l.useCallback(async a=>{se(!0),N(null);try{const s=await Fe(a);w(s)}catch(s){N("Error al cargar la lista de archivos para este caso."),console.error("Error fetching archivos:",s),w([])}finally{se(!1)}},[]);l.useEffect(()=>{n?P(n):(w([]),N(null))},[n,P]);const ce=l.useCallback(async a=>{T(!0),b([]),x({}),S(null);const s=new FileReader;s.onload=t=>{var o;try{const r=(o=t.target)==null?void 0:o.result;if(!r)throw new Error("No se pudo leer el archivo");const m=Ge(r,{type:"array"}),g=m.SheetNames[0],F=m.Sheets[g],R=Be.sheet_to_json(F,{header:1});if(R&&R.length>0){const O=R[0].map(p=>String(p||"").trim()).filter(p=>p.length>0);b(O);const z={},De=[...I[c],...V[c]],Ke=O.map(p=>p.toLowerCase()),ue=new Set;De.forEach(p=>{z[p]=null;const he=We[p];if(he)for(const pe of O){const q=pe.toLowerCase();if(he.includes(q)&&!ue.has(q)){z[p]=pe,ue.add(q);break}}}),x(z),d.show({title:"Cabeceras Leídas",message:"Se intentó un mapeo automático. Revisa la configuración.",color:"blue",autoClose:5e3})}else throw new Error("El archivo Excel está vacío o no tiene cabeceras.")}catch(r){S(`Error al leer las cabeceras: ${r.message}`),d.show({title:"Error de Lectura",message:`No se pudieron leer las cabeceras del Excel: ${r.message}`,color:"red"}),j(null)}finally{T(!1)}},s.onerror=t=>{S("Error al leer el archivo."),d.show({title:"Error de Archivo",message:"Ocurrió un error al intentar leer el archivo seleccionado.",color:"red"}),j(null),T(!1)},s.readAsArrayBuffer(a)},[c]);l.useEffect(()=>{i?ce(i):(b([]),x({}),S(null))},[i,ce]),l.useEffect(()=>{if(i){const a={};I[c].forEach(s=>a[s]=null),V[c].forEach(s=>a[s]=null),x(a)}},[c,i]);const ie=(a,s)=>{x(t=>({...t,[a]:s}))},_e=()=>{const a=I[c].filter(s=>!C[s]);if(a.length>0){d.show({title:"Mapeo Incompleto",message:`Debes seleccionar una columna del Excel para los siguientes campos requeridos: ${a.join(", ")}`,color:"orange"});return}d.show({title:"Mapeo Guardado",message:"La configuración del mapeo se ha guardado.",color:"teal",icon:e.jsx(be,{size:18})}),Z()},de=()=>I[c].every(a=>!!C[a]),we=async()=>{var a,s;if(!n||!i){d.show({title:"Faltan datos",message:"Selecciona un caso y un archivo.",color:"orange"});return}if(!de()){d.show({title:"Mapeo Incompleto",message:"Configura el mapeo de columnas antes de importar.",color:"orange"}),K();return}ee(!0),_(null);try{const t=Object.entries(C).filter(([r,m])=>m!==null).reduce((r,[m,g])=>(r[m]=g,r),{}),o=await Oe(n,c,i,JSON.stringify(t));if(d.show({title:"Éxito",message:`Archivo "${o.archivo.Nombre_del_Archivo}" importado. ID Archivo: ${o.archivo.ID_Archivo}`,color:"green"}),o.nuevos_lectores_creados&&o.nuevos_lectores_creados.length>0){const r=o.nuevos_lectores_creados.length;d.show({title:"Lectores Nuevos Creados",message:e.jsxs(H,{children:[e.jsxs(A,{size:"sm",children:["Se crearon automáticamente ",r," lectores nuevos."]}),e.jsx(A,{size:"sm",children:"Se recomienda revisar y completar su información."}),e.jsx(M,{size:"xs",variant:"light",mt:"xs",onClick:()=>te("/lectores"),children:"Ir a Gestión de Lectores"})]}),color:"blue",autoClose:1e4,withCloseButton:!0})}j(null),b([]),x({}),n&&await P(n)}catch(t){let o="Error al importar el archivo.",r=(s=(a=t.response)==null?void 0:a.data)==null?void 0:s.detail;if(console.error("Error completo recibido:",t.response||t),r)try{typeof r=="string"?o=`${o} Detalle: ${r}`:o=`${o} Detalle: 
${JSON.stringify(r,null,2)}`}catch{o=`${o} (No se pudo formatear detalle del error)`}else t.message&&(o=`${o} Mensaje: ${t.message}`);o.length>500&&(o=o.substring(0,497)+"..."),_(o)}finally{ee(!1)}},Me=async a=>{var s,t;if(window.confirm(`¿Estás seguro de que quieres eliminar el archivo ID ${a} y todas sus lecturas asociadas? Esta acción no se puede deshacer.`)){le(a);try{await ze(a),d.show({title:"Archivo Eliminado",message:`El archivo ID ${a} ha sido eliminado correctamente.`,color:"teal",icon:e.jsx(be,{size:18})}),w(o=>o.filter(r=>r.ID_Archivo!==a))}catch(o){console.error("Error al eliminar archivo:",o),d.show({title:"Error al Eliminar",message:((t=(s=o.response)==null?void 0:s.data)==null?void 0:t.detail)||o.message||"No se pudo eliminar el archivo.",color:"red",icon:e.jsx(L,{})})}finally{le(null)}}};return e.jsxs(H,{p:"md",children:[e.jsx(xe,{order:2,mb:"xl",children:"Importar Datos desde Excel"}),e.jsx(ge,{visible:v||h,overlayProps:{radius:"sm",blur:2}}),e.jsxs(ve,{gap:"lg",children:[e.jsx(G,{label:"Selecciona un Caso",placeholder:"Elige el caso al que importar el archivo",data:f,value:n,onChange:a=>{J(a);const s=f.find(t=>t.value===a);W(s?s.label.split(" - ")[1].split(" (")[0]:null),j(null),b([]),x({}),_(null),S(null)},searchable:!0,nothingFoundMessage:"No se encontraron casos",disabled:Se||v,error:Ae,mb:"md",required:!0}),e.jsx(B.Group,{name:"fileType",label:"Tipo de Archivo a Importar",value:c,onChange:a=>Ie(a),required:!0,mb:"md",children:e.jsxs(me,{mt:"xs",children:[e.jsx(B,{value:"LPR",label:"Datos LPR",disabled:v||h}),e.jsx(B,{value:"GPS",label:"Datos GPS",disabled:v||h})]})}),e.jsx(Ve,{label:"Archivo Excel",placeholder:i?i.name:"Selecciona o arrastra un archivo (.xlsx, .xls)",leftSection:e.jsx(Xe,{size:$e(18)}),value:i,onChange:j,accept:".xlsx, .xls",disabled:!n||v||h,clearable:!0,required:!0}),e.jsx(M,{leftSection:e.jsx(Qe,{size:18}),onClick:K,disabled:!i||v||h,variant:"outline",mt:"xs",children:"Configurar Mapeo de Columnas"}),E&&e.jsx(D,{title:"Error de Lectura",color:"red",icon:e.jsx(L,{}),children:E}),e.jsx(M,{leftSection:e.jsx(Ye,{size:18}),onClick:we,loading:v,disabled:!n||!i||!de()||h,mt:"lg",fullWidth:!0,children:"Importar Archivo"}),ae&&e.jsx(D,{title:"Error de Importación",color:"red",withCloseButton:!0,onClose:()=>_(null),icon:e.jsx(L,{}),children:ae})]}),e.jsx(ke,{opened:ye,onClose:Z,title:`Mapeo de Columnas para Archivo ${c}`,size:"lg",centered:!0,overlayProps:{backgroundOpacity:.55,blur:3},children:e.jsxs(ve,{gap:"md",children:[h&&e.jsx(Ne,{}),!h&&y.length===0&&!E&&e.jsx(A,{children:"Selecciona un archivo para ver las columnas."}),!h&&E&&e.jsx(D,{color:"red",children:E}),!h&&y.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(A,{size:"sm",children:"Asigna las columnas de tu archivo Excel a los campos requeridos y opcionales de la base de datos."}),e.jsx(U,{label:"Campos Requeridos",labelPosition:"center"}),I[c].map(a=>e.jsx(G,{label:a,placeholder:"Selecciona columna del Excel...",data:y,value:C[a],onChange:s=>ie(a,s),required:!0,clearable:!0},`req-${a}`)),e.jsx(U,{label:"Campos Opcionales",labelPosition:"center",mt:"md"}),V[c].map(a=>e.jsx(G,{label:a,placeholder:"Selecciona columna del Excel (opcional)...",data:y,value:C[a],onChange:s=>ie(a,s),clearable:!0},`opt-${a}`)),e.jsx(M,{onClick:_e,mt:"lg",children:"Guardar Mapeo"})]})]})}),n&&e.jsxs(H,{mt:"xl",children:[e.jsx(U,{my:"lg",label:"Archivos Importados",labelPosition:"center"}),Q&&e.jsxs(xe,{order:4,mb:"md",c:"tracerBlue.7",children:["Archivos para el caso: ",Q]}),e.jsx(ge,{visible:$,overlayProps:{radius:"sm",blur:2}}),!$&&k&&e.jsx(D,{color:"red",title:"Error al cargar archivos",icon:e.jsx(L,{}),children:k}),!$&&!k&&(oe.length>0?e.jsxs(u,{striped:!0,highlightOnHover:!0,withTableBorder:!0,withColumnBorders:!0,children:[e.jsx(u.Thead,{children:e.jsxs(u.Tr,{children:[e.jsx(u.Th,{children:"Nombre del Archivo"}),e.jsx(u.Th,{children:"Tipo"}),e.jsx(u.Th,{children:"Acciones"})]})}),e.jsx(u.Tbody,{children:oe.map(a=>e.jsxs(u.Tr,{children:[e.jsx(u.Td,{children:a.Nombre_del_Archivo}),e.jsx(u.Td,{children:a.Tipo_de_Archivo}),e.jsx(u.Td,{children:e.jsxs(me,{gap:"xs",children:[e.jsx(fe,{label:"Descargar Archivo Original",children:e.jsx(Re,{href:`${qe.defaults.baseURL}/archivos/${a.ID_Archivo}/download`,download:a.Nombre_del_Archivo,target:"_blank",children:e.jsx(je,{variant:"subtle",color:"blue",children:e.jsx(Je,{size:16})})})}),e.jsx(fe,{label:"Eliminar Archivo y Lecturas",children:e.jsx(je,{variant:"subtle",color:"red",onClick:()=>Me(a.ID_Archivo),loading:re===a.ID_Archivo,disabled:re!==null,children:e.jsx(He,{size:16})})})]})})]},a.ID_Archivo))})]}):e.jsx(A,{children:"No hay archivos importados para este caso."}))]})]})}export{ca as default};
