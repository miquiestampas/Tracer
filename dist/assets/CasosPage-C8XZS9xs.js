import{k as A,l,m as H,j as s,B as J,G as u,i as K,n as x,o as Q,L as X,T as E,M as Z,p as i}from"./index-ChNr1GaT.js";import{g as ee,u as se,d as oe,a as ae,c as re}from"./casosApi-CONg4Tmm.js";import{_ as te,T as y,N as le}from"./lodash-CBZiuDCF.js";import{u as ne,T as ie,a as N,A as S,S as de}from"./Title-DqhdHHkm.js";import{u as ce,I as ue}from"./use-form-hDBYc0fM.js";import{A as me,I as pe,a as he}from"./api-B9d806Z_.js";import{S as Ce,C as ge}from"./SimpleGrid-DOD9hVVF.js";import{S as xe}from"./Select-CmOM9iEN.js";import{T as fe}from"./Textarea-ELLLunE-.js";import"./get-base-value-JqT_q0U7.js";/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var be=A("outline","plus","IconPlus",[["path",{d:"M12 5l0 14",key:"svg-0"}],["path",{d:"M5 12l14 0",key:"svg-1"}]]);/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var je=A("outline","sort-ascending","IconSortAscending",[["path",{d:"M4 6l7 0",key:"svg-0"}],["path",{d:"M4 12l7 0",key:"svg-1"}],["path",{d:"M4 18l9 0",key:"svg-2"}],["path",{d:"M15 9l3 -3l3 3",key:"svg-3"}],["path",{d:"M18 6l0 12",key:"svg-4"}]]);/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var _e=A("outline","sort-descending","IconSortDescending",[["path",{d:"M4 6l9 0",key:"svg-0"}],["path",{d:"M4 12l7 0",key:"svg-1"}],["path",{d:"M4 18l7 0",key:"svg-2"}],["path",{d:"M15 15l3 3l3 -3",key:"svg-3"}],["path",{d:"M18 6l0 12",key:"svg-4"}]]);const Ie=["Nuevo","Esperando Archivos","En Análisis","Pendiente Informe","Cerrado"];function Ee(d){switch(d){case"Nuevo":return"green";case"Esperando Archivos":return"blue";case"En Análisis":return"orange";case"Pendiente Informe":return"red";case"Cerrado":return"gray";default:return"gray"}}function ze(){const[d,m]=l.useState([]),[D,v]=l.useState(!0),[f,w]=l.useState(null),[F,{open:M,close:k}]=ne(!1),[V,T]=l.useState(null),[P,z]=l.useState(null),[p,b]=l.useState(null);H();const[h,$]=l.useState(""),[C,L]=l.useState("Fecha_de_Creacion"),[g,O]=l.useState("desc"),n=ce({initialValues:{Nombre_del_Caso:"",Año:new Date().getFullYear(),Descripcion:"",NIV:""},validate:{Nombre_del_Caso:e=>e.trim().length>0?null:"El nombre del caso es obligatorio",Año:e=>e>1900&&e<=new Date().getFullYear()+1?null:"Introduce un año válido"}});l.useEffect(()=>{j()},[]);const j=async()=>{v(!0),w(null);try{const e=await ee();m(e)}catch(e){w("Error al cargar los casos. Inténtalo de nuevo."),console.error(e)}finally{v(!1)}},G=async e=>{try{const o={...e,Año:Number(e.Año)||0};await re(o),i.show({title:"Caso Creado",message:`El caso "${e.Nombre_del_Caso}" ha sido creado exitosamente.`,color:"green"}),n.reset(),k(),j()}catch(o){let r="Error al crear el caso.";o.response&&o.response.data&&o.response.data.detail&&(r=`${r} ${o.response.data.detail}`),i.show({title:"Error",message:r,color:"red"})}},B=async e=>{var o,r;if(window.confirm(`¿Estás SEGURO de que quieres eliminar el caso ID ${e}? 

¡ATENCIÓN! Esta acción eliminará permanentemente el caso, TODOS sus archivos importados y TODAS las lecturas asociadas. Esta acción NO se puede deshacer.`)){T(e);try{await oe(e),i.show({title:"Caso Eliminado",message:`El caso ID ${e} y todos sus datos asociados han sido eliminados correctamente.`,color:"teal"}),m(a=>a.filter(t=>t.ID_Caso!==e))}catch(a){console.error("Error al eliminar caso:",a);let t=((r=(o=a.response)==null?void 0:o.data)==null?void 0:r.detail)||a.message||"No se pudo eliminar el caso.";i.show({title:"Error al Eliminar",message:t,color:"red"})}finally{T(null)}}},R=async(e,o)=>{var a;if(!o)return;z(e);const r=(a=d.find(t=>t.ID_Caso===e))==null?void 0:a.Estado;m(t=>t.map(c=>c.ID_Caso===e?{...c,Estado:o}:c));try{await se(e,o)}catch{i.show({title:"Error al Actualizar Estado",message:`No se pudo actualizar el estado del caso ${e}. Revirtiendo cambio.`,color:"red"}),m(c=>c.map(I=>I.ID_Caso===e?{...I,Estado:r||"Nuevo"}:I))}finally{z(null)}},q=l.useMemo(()=>{let e=d;if(h.trim()){const r=h.toLowerCase().trim();e=d.filter(a=>a.Nombre_del_Caso.toLowerCase().includes(r)||String(a.Año).includes(r)||a.NIV&&a.NIV.toLowerCase().includes(r)||a.Descripcion&&a.Descripcion.toLowerCase().includes(r))}return te.orderBy(e,[C],[g])},[d,h,C,g]),U=()=>{n.reset(),b(null),M()},Y=e=>{b(e.ID_Caso),n.setValues({Nombre_del_Caso:e.Nombre_del_Caso,Año:e.Año,Descripcion:e.Descripcion||"",NIV:e.NIV||""}),M()},_=()=>{n.reset(),b(null),k()},W=async(e,o)=>{const r={...o,Año:Number(o.Año)||0};console.log("Actualizando caso:",e,r);try{await ae(e,r),i.show({title:"Caso Actualizado",message:`El caso "${o.Nombre_del_Caso}" ha sido actualizado.`,color:"blue"}),_(),j()}catch(a){let t="Error al actualizar el caso.";a.response&&a.response.data&&a.response.data.detail&&(t=`${t} ${a.response.data.detail}`),i.show({title:"Error",message:t,color:"red"})}};return s.jsxs(J,{children:[s.jsx(ie,{order:2,mb:"xl",children:"Gestión de Casos"}),s.jsxs(u,{justify:"space-between",mb:"lg",children:[s.jsx(y,{placeholder:"Buscar por nombre, año, NIV, descripción...",leftSection:s.jsx(K,{size:14}),value:h,onChange:e=>$(e.currentTarget.value),style:{flexGrow:1,maxWidth:"400px"}}),s.jsxs(u,{children:[(()=>{let e="";return C==="Fecha_de_Creacion"?e="Fecha Creación":C==="Nombre_del_Caso"?e="Nombre":e="Año",s.jsxs(x,{variant:"default",size:"xs",onClick:()=>L(o=>o==="Fecha_de_Creacion"?"Nombre_del_Caso":o==="Nombre_del_Caso"?"Año":"Fecha_de_Creacion"),children:["Ordenar por: ",e]})})(),s.jsx(N,{label:`Orden ${g==="asc"?"Descendente":"Ascendente"}`,children:s.jsx(S,{variant:"default",size:"xs",onClick:()=>O(e=>e==="asc"?"desc":"asc"),children:g==="asc"?s.jsx(je,{size:16}):s.jsx(_e,{size:16})})}),s.jsx(x,{leftSection:s.jsx(be,{size:14}),onClick:U,children:"Crear Nuevo Caso"})]})]}),D&&s.jsx(Q,{}),f&&s.jsx(me,{title:"Error",color:"red",icon:s.jsx(pe,{}),children:f}),!D&&!f&&s.jsx(Ce,{cols:{base:1,sm:2,md:3,lg:4},spacing:"lg",children:q.map(e=>s.jsxs(ge,{shadow:"sm",padding:"lg",radius:"md",withBorder:!0,style:{cursor:"pointer",borderLeft:`5px solid var(--mantine-color-${Ee(e.Estado)}-6)`},children:[s.jsxs(X,{to:`/casos/detalle/${e.ID_Caso}`,style:{textDecoration:"none",color:"inherit",display:"block"},children:[s.jsx(u,{justify:"space-between",mt:"md",mb:"xs",children:s.jsx(E,{fw:500,size:"lg",truncate:!0,children:e.Nombre_del_Caso})}),s.jsxs(E,{size:"sm",c:"dimmed",mb:"sm",children:["Año: ",e.Año," | NIV: ",e.NIV||"-"]}),s.jsx(E,{size:"sm",c:"dimmed",lineClamp:3,children:e.Descripcion||"Sin descripción"})]}),s.jsx(xe,{mt:"md",size:"xs",data:Ie.map(o=>({value:o,label:o})),value:e.Estado,onChange:o=>R(e.ID_Caso,o),disabled:P===e.ID_Caso,placeholder:"Cambiar estado",comboboxProps:{shadow:"md",transitionProps:{transition:"pop",duration:200}}}),s.jsxs(u,{justify:"flex-end",mt:"md",children:[s.jsx(N,{label:"Editar Caso",children:s.jsx(S,{variant:"light",color:"gray",onClick:()=>Y(e),children:s.jsx(ue,{size:16})})}),s.jsx(N,{label:"Eliminar Caso",children:s.jsx(S,{variant:"light",color:"red",onClick:()=>B(e.ID_Caso),loading:V===e.ID_Caso,children:s.jsx(he,{size:16})})})]})]},e.ID_Caso))}),s.jsx(Z,{opened:F,onClose:_,title:p?"Editar Caso":"Crear Nuevo Caso",centered:!0,children:s.jsx("form",{onSubmit:n.onSubmit(p?e=>W(p,e):G),children:s.jsxs(de,{children:[s.jsx(y,{required:!0,label:"Nombre del Caso",placeholder:"Ej: Investigación vehículo sospechoso",...n.getInputProps("Nombre_del_Caso")}),s.jsx(le,{required:!0,label:"Año",placeholder:"Año del caso",min:1900,max:new Date().getFullYear()+1,...n.getInputProps("Año")}),s.jsx(y,{label:"NIV (Opcional)",placeholder:"Número de Identificación Vehicular",...n.getInputProps("NIV")}),s.jsx(fe,{label:"Descripción (Opcional)",placeholder:"Detalles relevantes sobre el caso",autosize:!0,minRows:2,...n.getInputProps("Descripcion")}),s.jsxs(u,{justify:"flex-end",mt:"md",children:[s.jsx(x,{variant:"default",onClick:_,children:"Cancelar"}),s.jsx(x,{type:"submit",children:p?"Guardar Cambios":"Crear Caso"})]})]})})})]})}export{ze as default};
